http://www.docin.com/p-594635048.html 综述

http://www.cnseay.com/2396/ 绕过

http://www.docin.com/p-641309785.html

http://zhaisj.blog.51cto.com/219066/1173352/

https://wenku.baidu.com/view/a285bf9d51e79b89680226f2.html?re=view

https://wenku.baidu.com/view/3a87bf26ccbff121dd368326.html  fragroute

IDS 逃逸的技术

1998年提出的分片逃逸--》开始出现IDS的逃逸技术

## 1、网络层逃逸

​      IP层的ip分片机制导致的逃逸主要有: 碎片化  分片重叠   分片超时

TCP层同样存在！！！

1、碎片化  ：主要讲IP报文分层多个ip碎片进行发送。有的ids对分片处理不好，组装不成功则可以达到攻击的效果。工具:fragroute

2、分片重叠技术：分片重叠由于操作系统不同存在俩种算法，frag_old  frag_new ,新的分片覆盖老的。或者相反。由于此，IDS只能选择其一，那么就会造成IDS与后面主机的不一致。规避办法，拒绝分片重叠数据，丢弃。--或者获取主机信息。或者安装主机IDS.工具:fragroute  fragtest

3、分片超时攻击：通过发送分片报文，由于IDS的资源有限，会在一定时间老花掉分片，如果此时在IDS老化掉改报文，而主机还未老化的情形下发送下一个分片，则会导致IDS与主机信息的不一致。以此主机获取了完整的攻击报文，被攻击，而IDS由于报文的老化，重组失败未能获取到攻击。还有另外一种TTL的方式，采用TTL到达IDS，被IDS获取，而部分报文没有到达主机，从而使俩者的获取信息不一致，混淆IDS，而主机获取到完整攻击。--实现不易



## 2、应用层逃逸

 编码混淆   载荷变换  应用与协议的特性

1、编码混淆，1、采用IDS没有的编码机制 2、编码多态 -- 每一种编码细节的细微变换。

2、载荷变换 -- 使特征匹配失效：1、大小写 2、路径变换  ./ // ../  3、URL参数编码  字符串转义   

3、应用或协议: 针对特定应用的IDS支持的差异，如http的请求管道可以携带多个URL，而IDS只是支持第一个URL,后续无条件通过。

4、多态shellcode  ==>> 缓冲区溢出!!



## 3、其他逃逸的方式

1、拒绝服务的方式，采取如snot stick的方式发送大量的模拟攻击，淹没IDS ，导致隐藏真实的攻击可能性。

2、加密的方式



URL常使用的混淆：

 采用 16进制表示，如“%**”

 采用转义符“%u”将字符用UNICODE方式表示

随机变换大小写

用tab符（0x09或0x0b）或回车符（0x0d）做分隔符

加入特定或随机的干扰字符串

字符命令混淆：FTP、Telnet命令中随机添加一定数量的干扰字符(空格符、非文本控制符等)，这些干扰字符在服务器的处理过程中往往会被过滤掉；

 Http请求中填充：前边添加4个字节的随机字符，目标系统一般是忽略，而IPS/WAF则容易混淆。



Http分片：把http协议中的url请求分开到不同的IP分片中，躲避WAF的检查；

RPC分片：MS-RPC和Sun/ONC RPC都允许应用程序以分片的方式发送请求，这些分片在RPC服务器内会被重新组装成完整请求形式，但分片可以躲避IPS的检查；

 字符协议的分段传送：这是开通远程控制窗口时常用的技巧，如FTP、Telnet等协议，攻击者的命令每次可以只发送几个字节，甚至是一个字母，让IPS不知所以；

分片重叠：前面举过的例子，人为制造分片重叠，取向不同结果就不同；

AET技术可以任意组合的特性让这一办法陷入困境。首先，躲避方式可以组合.

a) 当分片与重叠一起使用时，会让IPS/WAF的还原方式变得很复杂，若是多层协议同时分片，如TCP+RPC，再加上重叠时前向与后先问题，想要做到“全协议”检测是很困难的；

其次，不同协议可以组合，例如：

a) http、TCP、IP三层参数组合，可以这对常见的80端口躲避；

b) 针对CVE-2008-4250(MS08-067)，可以使用对涉及的协议IP、TCP、NetBios、SMB、MSRPC参数进行组合躲避；

//**启明星辰对STONESOFT的评价**-->>

Stonesoft公司提出“全协议解析”的解决方法，即对所有协议解析进行标准化检验，不符合协议标准的就“丢弃”。虽然可以减少重叠、填充、分片过小等带来的问题，**但这会因为线路质量不好时，造成大量业务重传或中断，治标而没治本。**

**对抗新型安全检测技术---沙箱**

针对APT攻击，对抗0day，很多安全厂家都采用了“沙箱”技术，诱使恶意代码露出原形，从而实现对未知攻击的防御。如何躲避沙箱的检测呢？“沙箱逃逸技术”成为新型AET技术的讨论重点。

恶意代码在解密自己前，会执行一些“无用代码”，检测自己是否存活在沙箱环境，若发现是“虚拟世界”，就停止下面的动作，若认为是真实客户就开始释放。
由于沙箱是模拟系统运行的环境，总是有很多模拟忽略的地方，如无法人机交互、模拟网卡的MAC、重要系统调用的钩子特征…犹如电影“盗梦空间”中，在梦境里，陀螺是永远转下去的一样。

很多安全公司使用的沙箱都是简易的，尤其是文件型沙箱，与VMWare的虚拟机相差甚远，可被发现的“虚拟痕迹”很多(所谓的沙箱漏洞)。也许未来对APT检测效果，要看沙箱模拟真实度与沙箱逃逸识别术，谁的技术更高一些吧。

APT攻击的最大特点是极具针对性与长期潜伏性，利用0DAY是APT攻击的常用方法，但毕竟使用0DAY的代价是高昂的，还有变成nDAY的风险。如果与AET技术相结合，发掘并建立攻击者与目标之间的长期“隐蔽通道”，对于APT攻击来说，如虎添翼，毕竟用户的安全防御体系不是可以很快就更新升级的。

AET技术已经成为信息安全界攻防双方研究的热点，一场在检测与逃逸之间的较量战正在拉开序幕
